<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Anti-Corruption System | SA Tender Monitoring</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="css/calculator.css">
    <link rel="stylesheet" href="css/blockchain.css">
    
    
</head>
<body>
    <!-- Header -->
    <header>
        <img src="img/south-africa.png" alt="SA Flag" class="header-img">
        <h1>Tender Monitoring & Verification System</h1>
        <div class="auth-links">
            <a href="../user/login.html">Login</a>
            <a href="../user/register.html">Register</a>
            <button id="themeToggle">ðŸŒ™</button>
        </div>
    </header>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="../user/index.html">Home</a>
            <a href="../user/tenders.html">Tenders</a>
            <a href="../user/investors.html">Investors</a>
            <a href="../user/government.html">Government</a>
            <a href="../user/news.html">News</a>
            <a href="../user/calculator.html">Calculator</a>
            <a href="../admin/anticorruption.html" class="active">Anti-Corruption</a>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="container">
        <div class="dashboard-header">
            <h1>Comprehensive Anti-Corruption Dashboard</h1>
            <p>Real-time monitoring of 500+ corruption vectors across all provinces with blockchain-backed immutability</p>
        </div>
        
        <div class="dashboard-grid">
            <!-- Filters Panel -->
            <div class="filters-panel">
                <h3>Filters</h3>
                <div class="filter-group">
                    <label for="corruptionType">Corruption Type</label>
                    <select class="filter-select" id="corruptionType">
                        <option value="all">All Types (500+)</option>
                        <option value="unfinished">Unfinished Projects</option>
                        <option value="ghost">Ghost Projects</option>
                        <option value="inflation">Price Inflation</option>
                        <option value="bid-rigging">Bid Rigging</option>
                        <option value="concentration">Company Concentration</option>
                        <option value="insider">Insider Threats</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="provinceFilter">Province</label>
                    <select class="filter-select" id="provinceFilter">
                        <option value="all">All Provinces</option>
                        <option value="gauteng">Gauteng</option>
                        <option value="western-cape">Western Cape</option>
                        <option value="kzn">KwaZulu-Natal</option>
                        <option value="eastern-cape">Eastern Cape</option>
                        <option value="limpopo">Limpopo</option>
                        <option value="mpumalanga">Mpumalanga</option>
                        <option value="north-west">North West</option>
                        <option value="free-state">Free State</option>
                        <option value="northern-cape">Northern Cape</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="active">Active Cases</option>
                        <option value="resolved">Resolved Cases</option>
                        <option value="critical">Critical Alerts</option>
                        <option value="blockchain">Blockchain-Verified</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="startDate">Date Range</label>
                    <input type="date" id="startDate" class="filter-input">
                    <input type="date" id="endDate" class="filter-input" style="margin-top: 5px;">
                </div>
                
                <button class="apply-filters" id="applyFilters">Apply Filters</button>
                <button class="reset-filters" id="resetFilters">Reset</button>
                
                <!-- Blockchain Verification Section -->
                <div class="blockchain-section">
                    <h3>Blockchain Verification</h3>
                    <p>All records are permanently stored on the blockchain</p>
                    <div class="blockchain-hash" id="latestBlockHash">
                        Latest Block: Loading...
                    </div>
                    <button class="blockchain-verify-btn" id="verifyBlockchain">Verify on Blockchain</button>
                </div>
                
                <!-- Insider Protection Section -->
                <div class="insider-protection">
                    <h3>Insider Threat Protection</h3>
                    <p>All user actions are cryptographically signed and recorded to prevent tampering</p>
                    <div class="blockchain-hash" id="userActionHash">
                        Your session fingerprint: Loading...
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="content-area">
                <!-- Stats Overview -->
                <div class="dashboard-card">
                    <h2>System Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>1,742</h3>
                            <p>Projects Monitored</p>
                        </div>
                        <div class="stat-card">
                            <h3>R62bn</h3>
                            <p>Potential Fraud Prevented</p>
                        </div>
                        <div class="stat-card">
                            <h3>328</h3>
                            <p>Companies Blacklisted</p>
                        </div>
                        <div class="stat-card">
                            <h3>99.1%</h3>
                            <p>Detection Accuracy</p>
                        </div>
                        <div class="stat-card">
                            <h3>100%</h3>
                            <p>Blockchain-Verified</p>
                        </div>
                    </div>
                </div>
                
                <!-- Corruption Map -->
                <div class="dashboard-card">
                    <h2>Provincial Corruption Heatmap</h2>
                    <div id="corruptionMap"></div>
                    <div class="map-legend">
                        <div><span class="legend-critical"></span> Critical Areas</div>
                        <div><span class="legend-warning"></span> High Risk</div>
                        <div><span class="legend-monitored"></span> Monitored</div>
                        <div><span class="legend-blockchain"></span> Blockchain Nodes</div>
                    </div>
                </div>
                
                <!-- Fraud Cases Table -->
                <div class="dashboard-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Recent Corruption Cases</h2>
                        <button id="exportBtn" class="export-btn">Export Data</button>
                    </div>
                    
                    <table class="fraud-table">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Tender</th>
                                <th>Type</th>
                                <th>Company</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="fraudCasesBody">
                            <!-- Cases will be loaded here by JavaScript -->
                        </tbody>
                    </table>
                    
                    <div class="pagination">
                        <button id="prevPage">Previous</button>
                        <span id="pageIndicator">Page 1 of 28</span>
                        <button id="nextPage">Next</button>
                    </div>
                </div>
                
                <!-- Prevention Mechanisms -->
                <div class="dashboard-card">
                    <h2>Active Prevention Systems</h2>
                    <div class="prevention-grid">
                        <div class="prevention-card blockchain-card">
                            <h3>Blockchain Verification</h3>
                            <p>All tender documents hashed and immutable with multi-signature requirements</p>
                            <div class="status-indicator active"></div>
                        </div>
                        <div class="prevention-card">
                            <h3>AI Pattern Detection</h3>
                            <p>Real-time bid anomaly monitoring with cross-referencing</p>
                            <div class="status-indicator active"></div>
                        </div>
                        <div class="prevention-card">
                            <h3>GPS Project Tracking</h3>
                            <p>Satellite verification of progress with blockchain timestamps</p>
                            <div class="status-indicator active"></div>
                        </div>
                        <div class="prevention-card">
                            <h3>Insider Threat Protection</h3>
                            <p>All user actions signed and logged to prevent tampering</p>
                            <div class="status-indicator active"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Audit Trail Section -->
                <div class="dashboard-card">
                    <h2>Recent Audit Trail</h2>
                    <table class="fraud-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Blockchain Hash</th>
                                <th>Verification</th>
                            </tr>
                        </thead>
                        <tbody id="auditTrailBody">
                            <!-- Audit logs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Blockchain Verification Modal -->
    <div id="blockchainModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Blockchain Verification</h2>
            <div id="verificationResult">
                <p>Verifying document on the blockchain network...</p>
            </div>
            <div class="blockchain-hash" id="modalBlockHash">
                Transaction Hash: Loading...
            </div>
            <div id="blockchainExplorerLink" style="margin-top: 15px;">
                <a href="#" target="_blank" id="explorerLink">View on Blockchain Explorer</a>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p>Â© 2024 Tender Monitoring System | Designed for Transparency and Growth</p>
            <div class="social-media">
                <a href="#"><img src="img/facebook.png" alt="Facebook"></a>
                <a href="#"><img src="img/twitter.png" alt="Twitter"></a>
                <a href="#"><img src="img/linkedin.png" alt="LinkedIn"></a>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
    <script>
        // Enhanced data with blockchain hashes and audit trails
        const fraudCases = [
            {
                id: "FC-2024-0451",
                tenderId: "TNDR-2024-0781",
                project: "Limpopo School Construction",
                type: "Unfinished Project",
                company: "ABC Builders (Pty) Ltd",
                amount: "R12,500,000",
                province: "limpopo",
                status: "critical",
                date: "2024-07-15",
                blockchainHash: "a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1",
                auditTrail: [
                    { timestamp: "2024-07-15 08:23:45", user: "auditor1@anticorruption.gov.za", action: "Case Opened", hash: "b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6" },
                    { timestamp: "2024-07-15 10:45:12", user: "investigator2@anticorruption.gov.za", action: "Evidence Added", hash: "d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8" }
                ]
            },
            {
                id: "FC-2024-0450",
                tenderId: "TNDR-2024-0672",
                project: "Eastern Cape Clinic",
                type: "Ghost Project",
                company: "HealthFront",
                amount: "R8,200,000",
                province: "eastern-cape",
                status: "resolved",
                date: "2024-07-12",
                blockchainHash: "b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6",
                auditTrail: [
                    { timestamp: "2024-07-12 09:15:33", user: "auditor3@anticorruption.gov.za", action: "Case Opened", hash: "a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1" },
                    { timestamp: "2024-07-12 14:22:10", user: "manager1@anticorruption.gov.za", action: "Case Resolved", hash: "c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9" }
                ]
            },
            {
                id: "FC-2024-0449",
                tenderId: "TNDR-2024-0563",
                project: "Gauteng Road Upgrade",
                type: "Price Inflation",
                company: "QuickBuild Pty Ltd",
                amount: "R45,000,000",
                province: "gauteng",
                status: "warning",
                date: "2024-07-10",
                blockchainHash: "d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8",
                auditTrail: [
                    { timestamp: "2024-07-10 11:05:21", user: "analyst4@anticorruption.gov.za", action: "Case Opened", hash: "e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1" },
                    { timestamp: "2024-07-10 16:45:18", user: "investigator1@anticorruption.gov.za", action: "Price Analysis Added", hash: "f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8" }
                ]
            },
            {
                id: "FC-2024-0448",
                tenderId: "TNDR-2024-0491",
                project: "Western Cape Housing",
                type: "Company Concentration",
                company: "UrbanDevelop",
                amount: "R32,000,000",
                province: "western-cape",
                status: "critical",
                date: "2024-07-08",
                blockchainHash: "e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1",
                auditTrail: [
                    { timestamp: "2024-07-08 10:30:15", user: "analyst2@anticorruption.gov.za", action: "Case Opened", hash: "d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1" },
                    { timestamp: "2024-07-08 15:12:47", user: "director1@anticorruption.gov.za", action: "Marked as Critical", hash: "b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2" }
                ]
            },
            {
                id: "FC-2024-0447",
                tenderId: "TNDR-2024-0382",
                project: "KZN Hospital Supplies",
                type: "Bid Rigging",
                company: "MedSolutions",
                amount: "R18,500,000",
                province: "kzn",
                status: "blockchain",
                date: "2024-07-05",
                blockchainHash: "f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8",
                auditTrail: [
                    { timestamp: "2024-07-05 09:45:22", user: "auditor4@anticorruption.gov.za", action: "Case Opened", hash: "c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3" },
                    { timestamp: "2024-07-05 11:30:10", user: "blockchain@anticorruption.gov.za", action: "Blockchain Verification", hash: "a4b3c2d1e0f9a8b7c6d5e4f3a2b1a3f4b2c1d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5" }
                ]
            }
        ];

        // Generate a random user session fingerprint
        function generateUserFingerprint() {
            const timestamp = new Date().toISOString();
            const randomValue = Math.random().toString(36).substring(2, 15);
            const userAgent = navigator.userAgent;
            return sha256(`${timestamp}-${randomValue}-${userAgent}`);
        }

        // Initialize Map with blockchain nodes
        function initMap() {
            const map = L.map('corruptionMap').setView([-28.4793, 24.6727], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            
            // Add markers for each case
            fraudCases.forEach(fraudCase => {
                const provinceCoords = {
                    'gauteng': [-26.2041, 28.0473],
                    'western-cape': [-33.9249, 18.4241],
                    'kzn': [-29.8587, 31.0218],
                    'eastern-cape': [-32.2968, 26.4194],
                    'limpopo': [-23.4013, 29.4179],
                    'mpumalanga': [-25.5653, 30.5279],
                    'north-west': [-26.6639, 25.2838],
                    'free-state': [-28.4541, 26.7968],
                    'northern-cape': [-29.0467, 21.8569]
                };
                
                const coords = provinceCoords[fraudCase.province] || [-28.4793, 24.6727];
                const color = fraudCase.status === 'critical' ? 'red' : 
                             fraudCase.status === 'warning' ? 'orange' : 
                             fraudCase.status === 'blockchain' ? 'purple' : 'green';
                
                L.circleMarker(coords, {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.5,
                    radius: 8
                }).addTo(map)
                .bindPopup(`
                    <strong>${fraudCase.project}</strong><br>
                    Type: ${fraudCase.type}<br>
                    Company: ${fraudCase.company}<br>
                    Amount: ${fraudCase.amount}<br>
                    <small>Blockchain: ${fraudCase.blockchainHash.substring(0, 12)}...</small>
                `);
            });
            
            // Add blockchain nodes (fixed locations for demo)
            const blockchainNodes = [
                { name: "Pretoria Node", coords: [-25.7479, 28.2293] },
                { name: "Cape Town Node", coords: [-33.9249, 18.4241] },
                { name: "Durban Node", coords: [-29.8587, 31.0218] },
                { name: "Bloemfontein Node", coords: [-29.1167, 26.2167] },
                { name: "Johannesburg Node", coords: [-26.2041, 28.0473] }
            ];
            
            blockchainNodes.forEach(node => {
                L.circleMarker(node.coords, {
                    color: 'purple',
                    fillColor: 'purple',
                    fillOpacity: 1,
                    radius: 6
                }).addTo(map)
                .bindPopup(`<strong>${node.name}</strong><br>Blockchain Validation Node`);
            });
        }

        // Load Fraud Cases into Table
        function loadCases(cases = fraudCases) {
            const tbody = document.getElementById('fraudCasesBody');
            tbody.innerHTML = '';
            
            cases.forEach(fraudCase => {
                const statusClass = `status-${fraudCase.status}`;
                const statusText = fraudCase.status === 'blockchain' ? 'BLOCKCHAIN-VERIFIED' : fraudCase.status.toUpperCase();
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fraudCase.id}</td>
                    <td><strong>${fraudCase.tenderId}</strong><br>${fraudCase.project}</td>
                    <td>${fraudCase.type}</td>
                    <td>${fraudCase.company}</td>
                    <td>${fraudCase.amount}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><button class="view-details" data-caseid="${fraudCase.id}">Details</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to detail buttons
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const caseId = this.getAttribute('data-caseid');
                    viewDetails(caseId);
                });
            });
            
            // Load audit trail
            loadAuditTrail();
        }

        // Load Audit Trail
        function loadAuditTrail() {
            const tbody = document.getElementById('auditTrailBody');
            tbody.innerHTML = '';
            
            // Get all audit entries from all cases
            const allAuditEntries = [];
            fraudCases.forEach(fraudCase => {
                fraudCase.auditTrail.forEach(entry => {
                    allAuditEntries.push({
                        ...entry,
                        caseId: fraudCase.id
                    });
                });
            });
            
            // Sort by timestamp (newest first)
            allAuditEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Display the 10 most recent entries
            allAuditEntries.slice(0, 10).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.timestamp}</td>
                    <td>${entry.user}</td>
                    <td>${entry.action} (Case ${entry.caseId})</td>
                    <td class="blockchain-hash">${entry.hash.substring(0, 12)}...</td>
                    <td><button class="verify-action" data-hash="${entry.hash}">Verify</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to verify buttons
            document.querySelectorAll('.verify-action').forEach(button => {
                button.addEventListener('click', function() {
                    const actionHash = this.getAttribute('data-hash');
                    verifyOnBlockchain(actionHash);
                });
            });
        }

        // View Details Function with blockchain info
        function viewDetails(caseId) {
            const fraudCase = fraudCases.find(c => c.id === caseId);
            if (fraudCase) {
                let auditTrailHTML = '<h3>Audit Trail</h3><ul>';
                fraudCase.auditTrail.forEach(entry => {
                    auditTrailHTML += `<li>${entry.timestamp} - ${entry.user} - ${entry.action}<br>
                    <small>Hash: ${entry.hash}</small></li>`;
                });
                auditTrailHTML += '</ul>';
                
                alert(`Case Details:\n\nID: ${fraudCase.id}\nTender: ${fraudCase.tenderId}\nProject: ${fraudCase.project}\nType: ${fraudCase.type}\nCompany: ${fraudCase.company}\nAmount: ${fraudCase.amount}\nStatus: ${fraudCase.status}\nDate: ${fraudCase.date}\n\nBlockchain Hash: ${fraudCase.blockchainHash}\n\n${auditTrailHTML}`);
            }
        }

        // Verify on Blockchain
        function verifyOnBlockchain(hash) {
            const modal = document.getElementById('blockchainModal');
            const modalContent = document.getElementById('verificationResult');
            const modalHash = document.getElementById('modalBlockHash');
            const explorerLink = document.getElementById('explorerLink');
            
            // Show loading state
            modalContent.innerHTML = '<p>Verifying document on the blockchain network...</p>';
            modalHash.textContent = `Transaction Hash: ${hash.substring(0, 24)}...`;
            explorerLink.href = `https://blockexplorer.example.com/tx/${hash}`;
            
            // Open modal
            modal.style.display = 'block';
            
            // Simulate blockchain verification (in real app this would be an API call)
            setTimeout(() => {
                // For demo purposes, we'll just show a success message
                modalContent.innerHTML = `
                    <p style="color: var(--verified-green); font-weight: bold;">âœ“ Document verified on blockchain</p>
                    <p>This record has been confirmed by 12 independent nodes in the network and cannot be altered.</p>
                    <p>Timestamp: ${new Date().toISOString()}</p>
                `;
            }, 1500);
        }

        // Filter Functionality
        function applyFilters() {
            const typeFilter = document.getElementById('corruptionType').value;
            const provinceFilter = document.getElementById('provinceFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const filteredCases = fraudCases.filter(fraudCase => {
                const typeMatch = typeFilter === 'all' || 
                                (typeFilter === 'insider' ? fraudCase.type.toLowerCase().includes('insider') : 
                                 fraudCase.type.toLowerCase().includes(typeFilter));
                const provinceMatch = provinceFilter === 'all' || fraudCase.province === provinceFilter;
                const statusMatch = statusFilter === 'all' || 
                                  (statusFilter === 'blockchain' ? fraudCase.status === 'blockchain' : 
                                   fraudCase.status === statusFilter);
                const dateMatch = (!startDate || fraudCase.date >= startDate) && 
                                 (!endDate || fraudCase.date <= endDate);
                
                return typeMatch && provinceMatch && statusMatch && dateMatch;
            });
            
            loadCases(filteredCases);
        }

        // Reset Filters
        function resetFilters() {
            document.getElementById('corruptionType').value = 'all';
            document.getElementById('provinceFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            loadCases();
        }

        // Export to CSV
        function exportToCSV() {
            const headers = ['Case ID', 'Tender ID', 'Project', 'Type', 'Company', 'Amount', 'Status', 'Date', 'Blockchain Hash'];
            const csvRows = [headers.join(',')];
            
            fraudCases.forEach(fraudCase => {
                const values = [
                    fraudCase.id,
                    fraudCase.tenderId,
                    fraudCase.project,
                    fraudCase.type,
                    fraudCase.company,
                    fraudCase.amount,
                    fraudCase.status.toUpperCase(),
                    fraudCase.date,
                    fraudCase.blockchainHash
                ];
                csvRows.push(values.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'fraud_cases_export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Pagination
        let currentPage = 1;
        const casesPerPage = 10;
        
        function updatePagination() {
            const totalPages = Math.ceil(fraudCases.length / casesPerPage);
            document.getElementById('pageIndicator').textContent = `Page ${currentPage} of ${totalPages}`;
            
            const startIndex = (currentPage - 1) * casesPerPage;
            const endIndex = startIndex + casesPerPage;
            const paginatedCases = fraudCases.slice(startIndex, endIndex);
            
            loadCases(paginatedCases);
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(fraudCases.length / casesPerPage);
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            updatePagination();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadCases();
            updatePagination();
            
            // Generate user session fingerprint
            const userFingerprint = generateUserFingerprint();
            document.getElementById('userActionHash').textContent = `Your session fingerprint: ${userFingerprint.substring(0, 24)}...`;
            
            // Set latest block hash
            document.getElementById('latestBlockHash').textContent = `Latest Block: ${fraudCases[0].blockchainHash.substring(0, 24)}...`;
            
            // Event Listeners
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('verifyBlockchain').addEventListener('click', () => {
                verifyOnBlockchain(fraudCases[0].blockchainHash);
            });
            
            // Modal close button
            document.querySelector('.close-modal').addEventListener('click', function() {
                document.getElementById('blockchainModal').style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('blockchainModal')) {
                    document.getElementById('blockchainModal').style.display = 'none';
                }
            });
        });

        // Toggle Theme
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            
            // Additional dark theme styles would go here
            if (document.body.classList.contains('dark-theme')) {
                document.documentElement.style.setProperty('--primary-blue', '#1a73e8');
                document.documentElement.style.setProperty('--dark-blue', '#0d47a1');
                document.documentElement.style.setProperty('--blockchain-purple', '#9c64ff');
                document.documentElement.style.setProperty('background-color', '#121212');
                document.documentElement.style.setProperty('color', '#ffffff');
            } else {
                document.documentElement.style.setProperty('--primary-blue', '#004B87');
                document.documentElement.style.setProperty('--dark-blue', '#002147');
                document.documentElement.style.setProperty('--blockchain-purple', '#6e3fba');
                document.documentElement.style.setProperty('background-color', '#f5f7fa');
                document.documentElement.style.setProperty('color', '#333');
            }
        }
    </script>
</body>
</html>